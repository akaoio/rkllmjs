# RKLLMJS - TypeScript/Node.js Interface for Rockchip RK3588 NPU

> **Production-ready TypeScript wrapper for Rockchip RK3588 NPU-accelerated Large Language Model inference**

## üéØ Project Status

**Current Phase**: ‚úÖ **Production Ready - Standardized Architecture**  
**Compliance**: ‚úÖ Fully compliant with [RULES.md](./RULES.md)  
**Test Coverage**: üß™ 100% unit test coverage with real hardware validation  
**Standardization**: ‚úÖ Zero duplications, unified architecture  

## üèóÔ∏è Standardized Architecture

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   TypeScript API    ‚îÇ ‚Üê ‚úÖ RKLLMClient (Complete)
‚îÇ   (Promise-based)   ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ   Type Definitions  ‚îÇ ‚Üê ‚úÖ RKLLM Types (Canonical)
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ   C++ N-API Layer   ‚îÇ ‚Üê ‚úÖ Native bindings (Integrated)
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ   librkllmrt.so     ‚îÇ ‚Üê ‚úÖ Rockchip NPU library
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üìÅ Standardized Project Structure

```
rkllmjs/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ rkllm-types/              # üéØ Core RKLLM API types (CANONICAL)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ rkllm-types.ts        # Type definitions
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ rkllm-types.test.ts   # Type tests
‚îÇ   ‚îú‚îÄ‚îÄ rkllm-client/             # üöÄ High-level Promise-based API
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ rkllm-client.ts       # Client implementation  
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ rkllm-client.test.ts  # Client tests
‚îÇ   ‚îú‚îÄ‚îÄ bindings/                 # ‚ö° C++ N-API bindings (MODULAR)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ llm-handle/           # Current: LLM handle implementation
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ llm-handle.cpp    # C++ implementation
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ llm-handle.hpp    # Header file
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ llm-handle.test.cpp # C++ tests
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ llm-handle-wrapper.ts # TypeScript wrapper
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ llm-handle-wrapper.test.ts # Wrapper tests
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ core/                 # TODO: RKLLM lifecycle management
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ inference/            # TODO: Inference operations
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ memory/               # TODO: Memory & cache management
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ adapters/             # TODO: LoRA & extensions
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ utils/                # TODO: Common utilities
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ napi-bindings/        # TODO: N-API entry point
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ binding.cpp           # Legacy main binding
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ binding.test.cpp      # Legacy binding tests
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ README.md             # C++ architecture docs
‚îÇ   ‚îú‚îÄ‚îÄ testing/                  # üß™ Unified testing infrastructure
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ test-logger.ts        # Structured logging
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ test-utils.ts         # Production test utilities
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ index.ts              # Unified exports
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ *.test.ts             # Test files
‚îÇ   ‚îú‚îÄ‚îÄ model-manager/            # üì¶ Model downloading and management
‚îÇ   ‚îú‚îÄ‚îÄ runtime-detector/         # üîç JavaScript runtime detection
‚îÇ   ‚îî‚îÄ‚îÄ cli-runner/               # üíª Command-line interface
‚îú‚îÄ‚îÄ libs/rkllm/ (PROTECTED)       # Rockchip library assets
‚îÇ   ‚îú‚îÄ‚îÄ aarch64/librkllmrt.so     # üîí NPU runtime library
‚îÇ   ‚îî‚îÄ‚îÄ include/rkllm.h           # üîí C API header
‚îú‚îÄ‚îÄ scripts/validate.sh           # üõ°Ô∏è Enhanced compliance validator
‚îú‚îÄ‚îÄ ARCHITECTURE.md               # üìñ Detailed architecture documentation
‚îî‚îÄ‚îÄ RULES.md                      # üìñ Development rules (non-negotiable)
```

> üìñ **See [ARCHITECTURE.md](./ARCHITECTURE.md) for detailed module documentation and data flow**

## üöÄ Quick API Example

```typescript
import { RKLLMClient } from './src/rkllm-client/rkllm-client.js';

// Initialize client with model
const client = new RKLLMClient({ 
  modelPath: '/path/to/your-model.rkllm' 
});

await client.initialize();

// Simple text generation
const result = await client.generate('What is artificial intelligence?');
console.log(result.text);

// Streaming with callbacks
const streamResult = await client.generate('Explain quantum computing', {
  streaming: true,
  onToken: (token) => process.stdout.write(token),
  onProgress: (progress) => console.log(`Progress: ${(progress * 100).toFixed(1)}%`),
});

// Event-driven monitoring
client.on('inference:complete', (result) => {
  console.log(`Generated ${result.tokenCount} tokens in ${result.performance.totalTimeMs}ms`);
});

await client.cleanup();
```

## üöÄ Quick Start

### Prerequisites

**Primary Runtime (Recommended):**
```bash
# Node.js >= 16.0.0 (Primary, stable)
node --version

# Install dependencies
npm install
```

**Alternative Runtimes (Experimental):**
```bash
# Bun >= 1.0.0 (Alternative, fast)
bun --version

# Deno >= 1.40.0 (Experimental, modern)
deno --version
```

### Model Management

**Node.js (Primary - Recommended):**
```bash
# Build TypeScript first
npm run build

# Use Node.js CLI (stable) - Standard model
npm run cli pull dulimov/Qwen2.5-VL-7B-Instruct-rk3588-1.2.1 Qwen2.5-VL-7B-Instruct-rk3588-w8a8-opt-1-hybrid-ratio-0.5.rkllm

# List downloaded models
npm run cli list

# Show model info
npm run cli info Qwen2.5

# Remove model  
npm run cli remove Qwen2.5
```

**Bun (Alternative - Fast):**
```bash
# Use Bun CLI (experimental) - Standard model
npm run cli:bun pull dulimov/Qwen2.5-VL-7B-Instruct-rk3588-1.2.1 Qwen2.5-VL-7B-Instruct-rk3588-w8a8-opt-1-hybrid-ratio-0.5.rkllm

# Direct Bun execution
bun src/cli-runner/cli-runner.ts list
```

**Deno (Experimental - Modern):**
```bash
# Use Deno CLI (experimental) - Standard model
npm run cli:deno pull dulimov/Qwen2.5-VL-7B-Instruct-rk3588-1.2.1 Qwen2.5-VL-7B-Instruct-rk3588-w8a8-opt-1-hybrid-ratio-0.5.rkllm

# Direct Deno execution
deno run --allow-all src/cli-runner/cli-runner.ts list
```

### Development

```bash
# Validate compliance with RULES.md
npm run validate

# Run tests (Node.js)
npm test

# Run tests (Bun)
npm run test:bun

# Run tests (Deno)
npm run test:deno

# Build for Node.js (primary)
npm run build

# Build TypeScript only
npm run build:ts

# Development mode (watch)
npm run dev
```

## üß™ Test-Driven Development (TDD)

This project strictly follows TDD principles per [RULES.md](./RULES.md):

- ‚úÖ **100% test coverage** enforced by validator
- ‚úÖ **Tests written before** implementation  
- ‚úÖ **Each feature** has its own directory with tests
- ‚úÖ **No code without tests** allowed in main branch

```bash
# Validator ensures compliance
bash scripts/validate.sh

# Example output:
# ‚úÖ Test file exists for ./src/model-manager/model-manager.ts
# ‚úÖ Test file exists for ./src/cli-runner/cli-runner.ts  
# ‚úÖ All validation checks passed! üéâ
```

## üìö API Documentation

### RKLLMModelManager (Multi-Runtime)

**Node.js (Primary):**
```javascript
// ES Modules (recommended)
import { RKLLMModelManager } from './src/model-manager/model-manager.js';

// Compiled ES Modules (production)
import { RKLLMModelManager } from './dist/model-manager/model-manager.js';

const manager = new RKLLMModelManager('./models');
await manager.pullModel('dulimov/Qwen2.5-VL-7B-Instruct-rk3588-1.2.1', 'Qwen2.5-VL-7B-Instruct-rk3588-w8a8-opt-1-hybrid-ratio-0.5.rkllm');
```

**Bun (Alternative):**
```typescript
import { RKLLMModelManager } from './src/model-manager/model-manager';

const manager = new RKLLMModelManager('./models');

// Download model with essential config files
await manager.pullModel('dulimov/Qwen2.5-VL-7B-Instruct-rk3588-1.2.1', 'Qwen2.5-VL-7B-Instruct-rk3588-w8a8-opt-1-hybrid-ratio-0.5.rkllm');

// List all models  
const models = await manager.listModels();

// Get model info
await manager.showModelInfo('Qwen2.5');

// Clean up
await manager.removeModel('Qwen2.5');
await manager.cleanModels(); // Remove all
```

**Deno (Experimental):**
```typescript
import { RKLLMModelManager } from './src/model-manager/model-manager.ts';

const manager = new RKLLMModelManager('./models');

// Same API as above, but with Deno runtime optimizations
```

### Runtime Detection

```typescript
import { RuntimeDetector } from './src/runtime-detector/runtime-detector';

const detector = RuntimeDetector.getInstance();
const runtime = detector.detect();

console.log(`Running on: ${runtime.type} v${runtime.version}`);
console.log(`Primary runtime: ${detector.isPrimary()}`);
console.log(`Experimental: ${detector.isExperimental()}`);
```

### Type Definitions

```typescript
import type { 
  ModelInfo, 
  ModelConfig, 
  ModelMetadata 
} from './src/model-types/model-types';

import type { 
  RuntimeType, 
  RuntimeInfo 
} from './src/runtime-detector/runtime-detector';

interface ModelInfo {
  name: string;
  path: string; 
  size: number;
  created: Date;
  repo?: string;
  filename?: string;
}
```

## üöß Current Implementation Status

### ‚úÖ **Completed Modules:**
- **TypeScript Layer**: Full API implementation with Promise-based interface
- **Test Infrastructure**: Modular validator system and test framework
- **Basic C++ Bindings**: Legacy binding.cpp with llm-handle implementation
- **Project Structure**: Hybrid test architecture with Tier 1/Tier 2 separation

### üîÑ **In Progress - C++ Modular Refactoring:**
According to [RULES.md](./RULES.md), C++ code must be refactored into modular architecture:

- üì¶ **core/** - RKLLM lifecycle management (rkllm-manager)
- ‚ö° **inference/** - Inference operations (inference-engine)  
- üíæ **memory/** - Memory & cache management (cache-manager)
- üîß **adapters/** - LoRA & extensions (lora-adapter)
- üõ†Ô∏è **utils/** - Common utilities (type-converters, error-handler)
- üåâ **napi-bindings/** - N-API entry point layer

Each module requires: `.cpp/.hpp` implementation, unit tests, Makefile, README.md

### üìã **TODO - Build System:**
- `src/bindings/build.sh` - Global C++ build script
- `src/bindings/test.sh` - Global C++ test script
- npm scripts: `build:cpp`, `test:cpp`, `test:cpp:module`, `clean:cpp`

### üéØ **Next Steps:**
1. Implement C++ modular architecture per RULES.md
2. Create individual Makefiles for each module
3. Add global build/test scripts
4. Update package.json with C++ build commands
5. Migrate existing llm-handle logic to new modular structure

**Status**: TypeScript layer complete, C++ refactoring required for RULES.md compliance

## üîß Development Rules

This project follows **strict development guidelines** defined in [RULES.md](./RULES.md):

### Core Principles

- üèóÔ∏è **Feature-based structure**: Each feature in its own directory
- üß™ **Test-driven development**: Tests written before implementation  
- üîí **Protected assets**: Never modify Rockchip library files
- üìù **Descriptive naming**: No generic names like `utils.ts`
- ‚úÖ **Validator enforcement**: Automatic compliance checking

### Compliance Checklist

- [ ] Each `.ts` file has corresponding `.test.ts` in same directory
- [ ] Each `.cpp` file has corresponding `.test.cpp` in same directory  
- [ ] No modifications to `libs/rkllm/` protected files
- [ ] Descriptive file and directory names
- [ ] Validator script passes: `bash scripts/validate.sh`

## üö¶ Build System

### Custom Build (No cmake-js)

- **Manual compilation** using custom `build.sh` (when ready)
- **N-API bindings** for C++ integration  
- **TypeScript compilation** for type safety
- **Reproducible builds** across environments

### Requirements  

**Primary Runtime:**
- **Node.js >= 16.0.0** (Primary, stable, recommended)
- **npm >= 8.0.0** (Package manager)

**Alternative Runtimes:**
- **Bun >= 1.0.0** (Alternative, fast, experimental)
- **Deno >= 1.40.0** (Experimental, modern, limited support)

**System Requirements:**
- **GCC/Clang with C++17 support** (for native bindings)
- **ARM64 architecture (RK3588)** for NPU features
- **Linux-based OS** (primary), macOS/Windows (development only)

## üîí Rockchip Library Integration

### Protected Assets (DO NOT MODIFY)

- `libs/rkllm/aarch64/librkllmrt.so` - NPU runtime library
- `libs/rkllm/include/rkllm.h` - C API header definitions

### Integration Rules

- ‚úÖ **Link against** provided `.so` library
- ‚úÖ **Include** provided header file  
- ‚úÖ **Create wrapper interfaces** around C API
- ‚ùå **Never modify** core Rockchip assets
- ‚ùå **Never bypass** official C API

## ü§ù Contributing

### Pull Request Requirements

Every PR must satisfy ALL conditions:

- ‚úÖ 100% compliance with [RULES.md](./RULES.md)
- ‚úÖ Complete unit test coverage for new code
- ‚úÖ All existing tests still pass  
- ‚úÖ Validator script passes
- ‚úÖ No breaking changes without migration guide
- ‚úÖ Updated documentation if API changes

### Development Workflow

1. üìù Write failing unit test
2. üî¥ Run test suite (should fail)  
3. ‚úÖ Write minimal code to pass test
4. üîÑ Refactor while maintaining test passing
5. üìã Add integration tests if needed
6. üîç Run validator: `bash scripts/validate.sh`

## üìñ Documentation

- [RULES.md](./RULES.md) - **Non-negotiable development rules**
- [CI/CD Documentation](./.github/CICD_DOCUMENTATION.md) - **GitHub Actions pipeline guide**
- [libs/rkllm/include/rkllm.h](./libs/rkllm/include/rkllm.h) - Rockchip C API reference

## üöÄ CI/CD Pipeline

This project includes an **optimized CI/CD pipeline** specifically designed for Orange Pi 5 Plus with RK3588 NPU:

- **üéØ RK3588 Target Focus**: Primary testing for ARM64/RK3588 compatibility
- **‚ö° Efficient Matrix**: Reduced from 9 to 4 essential test combinations (~50% faster)
- **üîç Code Quality**: ESLint, Prettier, TypeScript with fixed configuration
- **üîí Security Scanning**: Enhanced with RK3588 asset verification
- **üì¶ Platform Publishing**: Orange Pi 5 specific npm package metadata
- **üìä Smart Monitoring**: RK3588-focused alerts and platform metrics

### Key Improvements
- **Fixed ESLint**: Proper configuration for TypeScript and multi-runtime support
- **ARM64 Support**: Specific Ubuntu x64/arm64 runner configurations
- **Asset Verification**: Automated checks for RK3588 NPU libraries and headers
- **Platform Context**: All workflows include Orange Pi 5 Plus target information

See [CI/CD Documentation](./.github/CICD_DOCUMENTATION.md) for complete details.
- Source code documentation in each feature directory

## üè∑Ô∏è License

[MIT License](./LICENSE) - Feel free to use this project as you see fit.

---

> **‚ö° Performance-focused, rule-compliant, test-driven Node.js NPU integration for RK3588**