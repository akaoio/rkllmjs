# Integration Test Makefile
CXX = g++
CXXFLAGS = -std=c++17 -Wall -Wextra -O2 -DNDEBUG
INCLUDES = -I../../libs/rkllm/include
LIBS = -L../../libs/rkllm/aarch64 -lrkllmrt -lpthread
RPATH = -Wl,-rpath,'$$ORIGIN/../../libs/rkllm/aarch64'

TARGET = integration-test
SOURCES = integration-test.cpp
OBJECTS = $(SOURCES:.cpp=.o)

# Link with our modules
MODULE_LIBS = core/librkllm-manager.a config/libconfig-manager.a

all: $(TARGET)

$(TARGET): $(OBJECTS) $(MODULE_LIBS)
	@echo "Building integration test..."
	$(CXX) $(CXXFLAGS) -o $@ $^ $(LIBS) $(RPATH)

%.o: %.cpp
	@echo "Compiling $<..."
	$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@

# Ensure modules are built first
$(MODULE_LIBS):
	@echo "Building required modules..."
	cd core && make
	cd config && make

test: $(TARGET)
	@echo "Running integration test..."
	./$(TARGET)

clean:
	rm -f $(OBJECTS) $(TARGET)

.PHONY: all test clean
